{% extends 'base.html' %}

{% block head %}
<title>Add New Client</title>
{% endblock %}

{% block content %}
<div class="p-6">
  <!-- Page Title -->
  <h1 class="text-3xl font-bold text-gray-800 mb-6">Add New Client</h1>

  <!-- Form Card -->
  <div class="bg-white shadow-lg rounded-xl p-6">
    <!-- IMPORTANT: add action for non-Stripe flows -->
    <form id="clientForm" method="POST" action="{{ url_for('clients.new_client') }}" class="space-y-6">

      <!-- Name Row -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
          <label for="first_name" class="block text-gray-600 mb-1">First Name</label>
          <input type="text" id="first_name" name="first_name" required
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
        </div>
        <div>
          <label for="middle_name" class="block text-gray-600 mb-1">Middle Name</label>
          <input type="text" id="middle_name" name="middle_name"
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
        </div>
        <div>
          <label for="last_name" class="block text-gray-600 mb-1">Last Name</label>
          <input type="text" id="last_name" name="last_name" required
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
        </div>
      </div>

      <!-- Email & Contact -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="email" class="block text-gray-600 mb-1">Email</label>
          <input type="email" id="email" name="email"
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
        </div>
        <div>
          <label for="contact" class="block text-gray-600 mb-1">Contact</label>
          <input type="text" id="contact" name="contact" required
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
        </div>
      </div>

      <!-- Gender -->
      <div>
        <label for="gender" class="block text-gray-600 mb-1">Gender</label>
        <select id="gender" name="gender"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
          <option value="Male">Male</option>
          <option value="Female">Female</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <!-- Address -->
      <div>
        <label for="address" class="block text-gray-600 mb-1">Address</label>
        <textarea id="address" name="address" rows="3"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"></textarea>
      </div>

      <!-- Plan & Package -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="plan" class="block text-gray-600 mb-1">Plan Duration</label>
          <select id="plan" name="plan" required
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
            <option value="3 Months">3 Months</option>
            <option value="6 Months">6 Months</option>
            <option value="12 Months">12 Months</option>
          </select>
        </div>
        <div>
          <label for="package" class="block text-gray-600 mb-1">Package</label>
          <select id="package" name="package" required
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
            {% for package in packages %}
              <option value="{{ package.id }}">{{ package.name }} - â‚¹{{ package.amount }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <!-- Trainer -->
       <div class="mb-4">
  <label for="trainer" class="block text-gray-800 font-medium mb-2">Trainer</label>
  <select id="trainer" name="trainer"
          class="w-full min-w-[200px] px-4 py-2 border-2 border-blue-400 bg-white rounded-lg shadow-md text-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none">
    <option value="" selected>-- No Trainer --</option>
    {% for trainer in trainers %}
      <option value="{{ trainer.id }}">{{ trainer.name }}</option>
    {% endfor %}
  </select>
</div>

    
<ul class="text-blue-600">
  {% for trainer in trainers %}
    <li>{{ trainer.first_name }} {{ trainer.last_name }}</li>
  {% else %}
    <li>No trainers found</li>
  {% endfor %}
</ul>



      <!-- Payment Method -->
      <div>
        <label for="payment_method" class="block text-gray-600 mb-1">Payment Method</label>
        <select id="payment_method" name="payment_method" required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
          <option value="Cash">Cash</option>
          <option value="Bank Transfer">Bank Transfer</option>
          <option value="Card">Card (Stripe)</option>
          <option value="UPI">UPI (Stripe)</option>
        </select>
      </div>

      <!-- Form Actions -->
      <div class="flex justify-end space-x-4">
        <a href="{{ url_for('clients.list_clients') }}"
           class="px-5 py-2.5 rounded-lg bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium transition">
          Cancel
        </a>
        <button type="submit"
                class="px-5 py-2.5 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold shadow-md transition transform hover:scale-105">
          Add Client
        </button>
      </div>
    </form>
  </div>
</div>

<script>
document.getElementById("clientForm").addEventListener("submit", async function(event) {
  const paymentMethod = document.getElementById("payment_method").value;

  // For Card/UPI go to Stripe Checkout via AJAX; otherwise normal form POST
  if (paymentMethod === "Card" || paymentMethod === "UPI") {
    event.preventDefault();

    const formData = new FormData(this);
    const data = {};
    formData.forEach((value, key) => { data[key] = value });

    try {
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const result = await res.json();
      if (res.ok && result.checkout_url) {
        window.location.href = result.checkout_url;
      } else {
        alert("Error: " + (result.error || "Unable to start payment"));
      }
    } catch (err) {
      alert("Error creating checkout session: " + err.message);
    }
  }
});
</script>
{% endblock %}
