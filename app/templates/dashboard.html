{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
{% endblock %}

{% block actions %}
<div class="flex justify-end mb-6">
  <a href="{{ url_for('clients.new_client', next=request.path) }}" 
     class="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 transition">
    + Add New Client
  </a>
</div>
{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-6">Dashboard</h1>

<!-- Summary Cards -->
<div class="summary-cards grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
  <div class="card total bg-white p-6 rounded-xl shadow">
    <div class="card-header text-gray-600 text-sm">Total Clients</div>
    <div class="card-value text-2xl font-bold">{{ total_clients }}</div>
    <div class="card-trend text-green-600 font-semibold">100%</div>
  </div>
  <div class="card active bg-white p-6 rounded-xl shadow">
    <div class="card-header text-gray-600 text-sm">Active Clients</div>
    <div class="card-value text-2xl font-bold">{{ active_clients }}</div>
    <div class="card-trend text-green-600 font-semibold">{{ active_pct }}%</div>
  </div>
  <div class="card inactive bg-white p-6 rounded-xl shadow">
    <div class="card-header text-gray-600 text-sm">Inactive Clients</div>
    <div class="card-value text-2xl font-bold">{{ inactive_clients }}</div>
    <div class="card-trend text-red-600 font-semibold">{{ inactive_pct }}%</div>
  </div>
</div>

<!-- Month/Year Selector -->
<form method="get" action="{{ url_for('dashboard.home') }}" class="month-year-form flex items-center gap-3 mb-8">
  <label for="month" class="font-medium">Month:</label>
  <select name="month" id="month" class="border rounded px-2 py-1">
    {% for m in range(1, 13) %}
      <option value="{{ m }}" {% if m == month %}selected{% endif %}>
        {{ ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][m-1] }}
      </option>
    {% endfor %}
  </select>

  <label for="year" class="font-medium">Year:</label>
  <select name="year" id="year" class="border rounded px-2 py-1">
    {% for y in range(2020, 2031) %}
      <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
    {% endfor %}
  </select>

  <button type="submit" 
          class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition">
    Show
  </button>
</form>

<!-- Business Growth Chart -->
<!-- Business Growth Chart -->
<h2 class="text-xl font-semibold mb-4">
  Business Growth ({{ ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][month-1] }} {{ year }})
</h2>
<div class="chart-wrapper bg-white p-6 rounded-xl shadow mb-8 w-full h-[400px]">
  <canvas id="growthChart" class="w-full h-full"></canvas>
</div>


<!-- Recent Clients -->
<h2 class="text-xl font-semibold mb-4">Recent Clients</h2>
<div class="overflow-x-auto">
  <table class="clients-table w-full border-collapse bg-white rounded-xl shadow">
    <thead class="bg-gray-100 text-left">
      <tr>
        <th class="py-2 px-4">ID</th>
        <th class="py-2 px-4">Initials</th>
        <th class="py-2 px-4">Name</th>
        <th class="py-2 px-4">Contact</th>
        <th class="py-2 px-4">Status</th>
        <th class="py-2 px-4">Billing Date</th>
        <th class="py-2 px-4">Duration</th>
        <th class="py-2 px-4">Action</th>
      </tr>
    </thead>
    <tbody>
    {% if recent_clients %}
      {% for c in recent_clients %}
        <tr class="border-t hover:bg-gray-50">
          <td class="py-2 px-4">#{{ c.id }}</td>
          <td class="py-2 px-4">{{ c.first_name[0] }}{{ c.last_name[0] if c.last_name else '' }}</td>
          <td class="py-2 px-4">{{ c.first_name }} {{ c.last_name or '' }}</td>
          <td class="py-2 px-4">{{ c.contact }}</td>
          <td class="py-2 px-4">{{ c.status }}</td>
          <td class="py-2 px-4">{{ c.billing_date.strftime('%d %B %Y') if c.billing_date else 'N/A' }}</td>
          <td class="py-2 px-4">{{ c.duration or 'N/A' }}</td>
          <td class="py-2 px-4 flex gap-2">
            <a href="{{ url_for('clients.view_client', client_id=c.id) }}" 
               class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition">View</a>
            <form action="{{ url_for('clients.delete_client', client_id=c.id) }}" method="POST" style="display:inline;">
              <button type="submit" 
                      class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition"
                      onclick="return confirm('Delete this client?');">
                Delete
              </button>
            </form>
          </td>
        </tr>
      {% endfor %}
    {% else %}
      <tr><td colspan="8" class="text-center py-4">No recent clients.</td></tr>
    {% endif %}
    </tbody>
  </table>
</div>

<script>
const ctx = document.getElementById('growthChart').getContext('2d');

// Create gradient for line
const gradient = ctx.createLinearGradient(0, 0, 0, 400);
gradient.addColorStop(0, 'rgba(34, 64, 197, 0.6)');  // top
gradient.addColorStop(1, 'rgba(34, 197, 94, 0.05)'); // bottom

const growthChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: {{ growth_dates|tojson }},
    datasets: [{
      label: 'Clients Joined',
      data: {{ growth_counts|tojson }},
      borderColor: '#2258c5ff', // vibrant green
      backgroundColor: gradient,
      tension: 0.4,
      fill: true,
      pointRadius: 6,
      pointHoverRadius: 10,
      pointBackgroundColor: '#227cc5ff',
      pointBorderColor: '#fff',
      pointBorderWidth: 2,
      shadowColor: 'rgba(34, 59, 197, 0.5)',
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      title: {
        display: true,
        text: 'Business Growth - Clients Joined',
        font: { size: 20, weight: 'bold' },
        color: '#333'
      },
      legend: {
        display: true,
        labels: {
          font: { size: 14 },
          color: '#555'
        }
      },
      tooltip: {
        backgroundColor: '#333',
        titleColor: '#fff',
        bodyColor: '#fff',
        titleFont: { weight: 'bold', size: 14 },
        bodyFont: { size: 13 },
        callbacks: {
          label: (context) => ` ${context.parsed.y} Clients`
        }
      }
    },
    scales: {
      x: {
        type: 'time',
        time: { unit: 'day', tooltipFormat: 'dd LLL yyyy' },
        grid: { color: 'rgba(200, 200, 200, 0.2)' },
        title: { display: true, text: 'Day', font: { weight: 'bold' } }
      },
      y: {
        beginAtZero: true,
        ticks: { precision: 0 },
        grid: { color: 'rgba(200, 200, 200, 0.2)' },
        title: { display: true, text: 'Clients Joined', font: { weight: 'bold' } }
      }
    },
    animation: {
      duration: 1500,
      easing: 'easeOutQuart'
    }
  }
});
</script>

{% endblock %}
